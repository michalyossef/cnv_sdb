isso (IAM single sign-on)
=====
Implemented as a sails-hook AND express middleware, isso provides your service with an easy way to identify who the user is calling your service. It uses Windows Authentication so your user doesn't have to re-login when hitting your service.

- Note: It only does authentication, not authorization. You must implement your own authorization approach.

Installation
========
```
npm install --save git://github.intel.com/securitydev/node-isso
```

Request access to Identity & Access Management Service (IAM WS):

1. Create a generic network account (sys_) at [globalrequest](http://globalrequest.intel.com)
2. After being notified of network account creation, go to [AGS](https://ags.intel.com), and select "Manage Generic Accounts" in the Identities section.
  1. Select "Update Generic Account" and click Next
  2. Search for your generic account name (sys_) and click Next
  3. Complete the required fields (Secondary Owner, Description, and IAP Name, as of this writing) and click Next, then Submit, then OK
3. Still in AGS, in the Access section, select "Submit Request" then "For Others"
  1. Search for your generic account name (sys_), toggle the selection so that it is added to the Selected Identities box, and click Submit
  2. In the Roles tab, enter "IAM WS-I" in the Search box and click Search
  3. Select Role "IAM WS-I Token_WindowsAuth Scope" and click "Add to Cart"
  4. Click "Checkout" in top right-hand corner, then click Submit
4. After you have gotten the user/pass finalized create a /config/isso.js file as follows:

```
/**** /config/isso.js ******/
var config = require('./configurator.config');

module.exports.isso = {
    iamUser: config.iamUser,
    iamPass: config.iamPass
};
```

- Note: If you're not using [configurator](https://github.intel.com/intc/configurator) you should consider it. It will make your life easier :). 

Usage
=====
isso adds an isso object into your req.session variable that can be used to 
determine the current user: ```req.session.isso.idsid``` and ```req.session.isso.domain```

Hello user Example: (sails.js, but concept works the same using express middleware)
```
/**** FooController.js *****/
module.exports = {
  find: function(req, res) {
    res.send('Hello ' + req.session.isso.domain + '\' + req.session.isso.idsid);
  }
};
```

### sails.js (if you used the [intc generator](https://github.intel.com/intc/intc-cli), this is the option you want. If not, you should consider it for next time)
If you're using sails.js, then installing isso will automatically authenticate all your routes with isso.
If that is not what you want you may customize isso (see [customization](#customization) below).

### express.js
isso works as express.js middleware. You must register at least 2 routes. The first should be the validateIssoToken route. The second will use isIssoAuthenticated for any routes you want protected.
below is a typical usage:
```
app.use(session({
	secret: require('intel-generate-secret')(),
	resave: false,
	saveUninitialized: true
}));

app.get('/validateisso',isso.validateIssoToken());

app.use(isso.isIssoAuthenticated());

app.get('/', function (req, res) {
	res.send('Hello ' + req.session.isso.idsid + '!');
});
```

If you are not using ```express-session``` then you will need to [customize](#customization) your middleware calls.

For the snippet above to work "as is" you'll also need ```intel-generate-secret```. Install using: 
```
npm install --save https://github.intel.com/intc/generate-secret
``` 

Configuration
========
configuration is done in the ```./config/isso.js``` file
a sample isso.js is below:

```
var config = require('./configurator.config');

module.exports.isso = {
    iamUser: config.iamUser,
    iamPass: config.iamPass,
    /*
    // these are the defaults for token generation and validation urls (IAM WS)
    tokenGenerateUrl: 'https://iamws-i.intel.com/api/v1/Windows/Auth'
    // this is the token validation url needed if you have a Rialto-I account for validation
    tokenValidateUrl: 'https://iamws-i.intel.com/api/v1/Windows/Auth'
    */
    /*
    // this is the token validation url needed if you have a Rialto-E account for validation
    tokenValidateUrl: 'https://iamws.intel.com/api/v1/Windows/Auth'
    */
};
```

### local development
Because IAM WS requires the authenticating url to be HTTPS, local development can be tricky.
One alternative is to override the isso process for local development.
This is done by adding a ```./config/isso.override.js``` file. __make sure you add it into your gitignore or you'll be overriding in production too.__

The contents should be something like :

```
// ./config/isso.override.js
module.exports = {
  "domain": "AMR",
  "idsid": "drpresto", 
  "raw": {
    "userName": "AMR\\drpresto",
      "name": {
        "formatted": "Preston, David R", "familyName": "Preston", "givenName": "David", "middleName": "R"
      },
    "displayName": "Preston, David R",
    "nickName": "Dave",
    "userType": "Internal",
    "preferredLanguage": "en_US",
    "active": true,
    "emails": [{"value": "david.r.preston@intel.com", "primary": true}],
    "id": "10501556",
    "externalId": "drpresto"
  }
};
```
Instead of hitting the IAM WS service it will just return the values in the override file, effectively authenticating everyone as the same person.

How does it work?
=====
Mostly magic (the good kind), but more specifically it uses the [IAM WS](https://iref.intel.com/GetDoc.aspx?RefLibObjectID=0902007c8004411d&Latest=True) to generate a token that is then validated and converted into the user's identity

isso installation is a hook that will send every route through the "isIssoAuthenticated" policy to ensure that the user's isso session is established. If not, it redirects to the IAM WS (and back again) to identify the user using windows auth.

Customization
======
### sails.js
By default isso will authenticate before ALL of your service calls in sail.js. 
If you don't want that, you must add configuration to isso.

```
//----- /config/isso.js
module.exports.isso = {
  routes: ['/v1/widgets*', '/v1/foos*']
};

```

### express.js
When calling the middleware you can pass in certain options. Below is a complete list with their defaults:
```
validateIssoToken({
	issoValidationRoot: 'https://sisso.intel.com/v2/token/validate', // TODO, update for isso conversion
	setIssoInfo: function(info, req) { req.session.isso = info; }
})

isIssoAuthentications({
	issoGenerateUrl: 'https://sisso.intel.com/v2/token/generate',
	localValidationPath: '/validateisso',
	getIssoInfo: function(req) { return req.session.isso; }
})
```
If you don't have sessions implemented with req.session, then you must customize using the setIssoInfo and getIssoInfo functions. Please recognize the below as only an example of functionality. It is __NOT__ a complete implementation as it will share one session for all users.
```
var poorManSession = {};

app.get('/validateisso',isso.validateIssoToken({
	setIssoInfo: function(issoData, req) {
		poorManSession.isso = issoData;
	}
}));

app.use(isso.isIssoAuthenticated({
	getIssoInfo: function(req) {
		return poorManSession.isso;
	}
}));

app.get('/', function (req, res) {
	res.send('Hello ' + poorManSession.isso.idsid + '!');
});
```

